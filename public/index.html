<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tmux-util - Session Manager</title>
    <style>
        :root {
            /* Light mode variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(255, 255, 255, 0.7);
            --text-primary: #2c3e50;
            --text-secondary: #64748b;
            --text-muted: #6c757d;
            --border-color: rgba(102, 126, 234, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --shadow-light: rgba(0, 0, 0, 0.05);
            --modal-bg: white;
            --input-bg: #f8f9fa;
            --input-border: #e9ecef;
            --input-focus: #667eea;
        }

        [data-theme="dark"] {
            /* Dark mode variables */
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-secondary: rgba(30, 30, 30, 0.95);
            --bg-tertiary: rgba(40, 40, 40, 0.7);
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --text-muted: #6c757d;
            --border-color: rgba(102, 126, 234, 0.2);
            --border-light: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-light: rgba(0, 0, 0, 0.2);
            --modal-bg: #2d3748;
            --input-bg: #4a5568;
            --input-border: #718096;
            --input-focus: #667eea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            margin: 0;
            transition: all 0.3s ease;
        }

        body.right-panel-open {
            padding-right: 42%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }



        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1 {
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px var(--shadow-color);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin: 0;
            font-weight: 500;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }



        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px var(--shadow-light);
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .status-indicator.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .section {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .section h2 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .session-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .session-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px var(--shadow-color);
            border-color: var(--border-color);
        }

        .session-card.attached {
            border-color: rgba(40, 167, 69, 0.3);
            background: var(--bg-secondary);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .session-name-section {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .session-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-original-name {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: monospace;
        }

        .session-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .session-status.attached {
            background: #d4edda;
            color: #155724;
        }

        .session-status.detached {
            background: #f8d7da;
            color: #721c24;
        }

        /* Dark mode adjustments for session status */
        [data-theme="dark"] .session-status.attached {
            background: #1e3a1e;
            color: #4ade80;
        }

        [data-theme="dark"] .session-status.detached {
            background: #3a1e1e;
            color: #f87171;
        }

        .session-details {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .session-details div {
            margin-bottom: 5px;
        }

        .active-window {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }



        .session-stats {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
            color: var(--text-muted);
            font-style: italic;
        }
        
        .actions {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        .actions .btn {
            flex: 1;
            min-width: 0;
            padding: 8px 12px;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .command-container {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 4px;
        }

        .command-text {
            font-family: 'Courier New', monospace;
            background: var(--input-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-primary);
            word-break: break-all;
            white-space: pre-wrap;
            max-width: 100%;
            overflow-wrap: break-word;
            flex: 1;
        }

        .window-info {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
        }





        .panes-section {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #e9ecef;
        }

        .panes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .panes-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-align: left;
        }

        .view-toggle {
            display: flex;
            align-items: center;
        }

        .view-toggle .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
        }



        .panes-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }



        .pane-info {
            background: var(--modal-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .pane-info.pane-active {
            border-color: #28a745;
            background: var(--input-bg);
        }

        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .pane-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pane-stream-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .pane-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .pane-active-badge {
            background: #28a745;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .pane-details {
            font-size: 0.85rem;
        }

        .pane-details > div {
            margin-bottom: 3px;
        }

        .pane-details > div:last-child {
            margin-bottom: 0;
        }

        .pane-details .pane-command,
        .pane-details .pane-path,
        .pane-details .pane-pid {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .pane-details .pane-command strong,
        .pane-details .pane-path strong,
        .pane-details .pane-pid strong {
            margin-bottom: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .pane-details .pane-command .command-text {
            display: block;
            margin-top: 3px;
            padding: 6px 8px;
            background: var(--input-bg);
            border-left: 3px solid #667eea;
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .path-text {
            font-family: 'Courier New', monospace;
            background: var(--input-bg);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-primary);
            word-break: break-all;
            display: block;
            margin-top: 3px;
        }

        .pid-text {
            font-family: 'Courier New', monospace;
            background: var(--input-bg);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-primary);
            display: block;
            margin-top: 3px;
        }

        .actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-size: 1.1rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px dashed var(--border-light);
        }

        .error {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(220, 53, 69, 0.2);
            backdrop-filter: blur(10px);
        }

        .success {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(40, 167, 69, 0.2);
            backdrop-filter: blur(10px);
        }

        .header-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: all 0.3s ease;
            padding: 0.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: rotate(180deg) translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #5a6fd8;
        }

        /* Session Details Panel */
        .details-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 3px solid #667eea;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
            max-height: 50vh;
            overflow-y: auto;
        }

        .details-panel.open {
            transform: translateY(0);
        }

        .details-header {
            background: var(--input-bg);
            padding: 15px 20px;
            border-bottom: 2px solid #667eea;
            box-shadow: 0 2px 4px var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-and-names {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .name-section {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .name-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .name-value {
            font-family: monospace;
            color: var(--text-primary);
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .window-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .window-dropdown-container {
            flex-shrink: 0;
        }

        .window-controls, .pane-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .window-controls .btn, .pane-controls .btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            white-space: nowrap;
        }



        .details-status {
            margin: 0;
        }

        .session-name-header {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .session-id-header {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: monospace;
        }

        .session-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .meta-item {
            margin-bottom: 2px;
        }

        .meta-item:last-child {
            margin-bottom: 0;
        }

        .close-details {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-details:hover {
            background: #e9ecef;
            color: #495057;
        }

        .details-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
            margin-bottom: 0;
        }

        .right-panel         .details-content {
            max-height: calc(100vh - 60px);
            transition: max-height 0.3s ease;
            padding-bottom: 20px;
        }

        .right-panel.stream-panel-open .details-content {
            max-height: calc(60vh - 80px);
            padding-bottom: 60px;
            margin-bottom: 40%;
        }


        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-value {
            color: var(--text-primary);
            text-align: right;
            flex: 1;
            margin: 0;
            padding: 0;
        }
        
        .window-dropdown {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: border-color 0.2s ease;
            margin: 0;
        }
        
        .window-dropdown:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }
        
        .selected-window-content {
            margin-top: 0;
        }
        
        .no-window-selected {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 20px;
            background-color: var(--input-bg);
            border-radius: 4px;
            border: 1px dashed var(--input-border);
        }
        
        .no-panes {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 10px;
            background-color: var(--input-bg);
            border-radius: 4px;
        }

        .detail-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .detail-status.attached {
            background: #d4edda;
            color: #155724;
        }

        .detail-status.detached {
            background: #f8d7da;
            color: #721c24;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Right Details Panel */
        .right-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40%;
            background: var(--modal-bg);
            border-left: 3px solid #667eea;
            box-shadow: -5px 0 20px var(--shadow-color);
            transform: translateX(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .right-panel.open {
            transform: translateX(0);
        }

        /* Stream Panel (nested in right panel) */
        .stream-panel {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 40%;
            background: #1e1e1e;
            border-top: 2px solid #667eea;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        }

        .stream-panel.open {
            transform: translateY(0);
        }

        /* Quick Actions Panel */
        .quick-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002;
            display: none;
        }

        .quick-actions.open {
            display: block;
        }

        .quick-actions .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quick-actions .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .quick-actions .action-btn:hover {
            background: #5a6fd8;
        }

        .quick-actions .action-btn.secondary {
            background: #6c757d;
        }

        .quick-actions .action-btn.secondary:hover {
            background: #5a6268;
        }

        .quick-actions .action-btn.danger {
            background: #dc3545;
        }

        .quick-actions .action-btn.danger:hover {
            background: #c82333;
        }

        /* Panel Status Indicator */
        .panel-status {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1003;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: none;
        }

        .panel-status.show {
            display: block;
        }

        /* Create Session Button */
        .create-session-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            padding: 12px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            text-decoration: none;
            min-width: 140px;
            justify-content: center;
        }

        .create-session-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        /* Dark mode adjustments for create session button */
        [data-theme="dark"] .create-session-btn {
            background: linear-gradient(135deg, #2d5a2d 0%, #1e4a3a 100%);
            box-shadow: 0 4px 15px rgba(45, 90, 45, 0.4);
        }

        [data-theme="dark"] .create-session-btn:hover {
            background: linear-gradient(135deg, #1e3a1e 0%, #152815 100%);
            box-shadow: 0 6px 20px rgba(45, 90, 45, 0.5);
        }

        .create-session-btn span {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Prominent Create Session Section */
        .create-session-section {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
            border: 2px dashed rgba(40, 167, 69, 0.3);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .create-session-section:hover {
            border-color: rgba(40, 167, 69, 0.5);
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(32, 201, 151, 0.15) 100%);
        }

        .create-session-section h3 {
            color: #155724;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .create-session-section p {
            color: #6c757d;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }

        .create-session-prominent {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .create-session-prominent:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .create-session-prominent span {
            font-size: 1.4rem;
            font-weight: bold;
        }

        /* Window and Pane Management Styles */
        .window-management {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--input-bg);
            border-radius: 6px;
            border: 1px solid var(--input-border);
        }

        .window-management h4 {
            display: none;
        }

        .window-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .window-actions .btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .pane-management {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--input-bg);
            border-radius: 6px;
            border: 1px solid var(--input-border);
        }

        .pane-management h4 {
            display: none;
        }

        .pane-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .pane-actions .btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: 12px;
            box-shadow: 0 20px 60px var(--shadow-color);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
        }

        /* Special styling for create session modal */
        #createSessionModal .modal-content {
            max-width: 600px;
            max-height: 80vh;
        }

        #createSessionModal .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        #createSessionModal .form-group {
            margin-bottom: 15px;
        }

        #createSessionModal .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #createSessionModal .form-group label::before {
            content: '';
            width: 3px;
            height: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        #createSessionModal .form-control {
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        #createSessionModal .form-control:focus {
            outline: none;
            border-color: var(--input-focus);
            background: var(--modal-bg);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #createSessionModal .form-control::placeholder {
            color: #adb5bd;
            font-style: italic;
        }

        /* Checkbox styling */
        #createSessionModal .form-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #667eea;
        }

        #createSessionModal .form-group label[for="modalDetached"] {
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        #createSessionModal .form-group label[for="modalDetached"]:hover {
            background: #e9ecef;
        }

        /* Required field indicator */
        #createSessionModal .form-group label[for="modalSessionName"]::after {
            content: ' *';
            color: #dc3545;
            font-weight: bold;
        }



        /* Dark mode toggle button */
        .dark-mode-toggle {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .dark-mode-toggle .light-mode-icon {
            display: none;
        }

        [data-theme="dark"] .dark-mode-toggle .dark-mode-icon {
            display: none;
        }

        [data-theme="dark"] .dark-mode-toggle .light-mode-icon {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #createSessionModal .modal-content {
                max-width: 95%;
                margin: 20px;
            }

            #createSessionModal .modal-body {
                padding: 20px;
            }

            .form-section {
                padding: 15px;
                margin-bottom: 20px;
            }
        }

        .modal-header {
            padding: 20px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        /* Enhanced header for create session modal */
        #createSessionModal .modal-header {
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 5px;
        }

        #createSessionModal .modal-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background: #e9ecef;
            color: #495057;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 0 20px 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Enhanced footer for create session modal */
        #createSessionModal .modal-footer {
            padding: 15px 20px 20px 20px;
            gap: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 5px;
            background: #f8f9fa;
        }

        #createSessionModal .modal-footer .btn {
            min-width: 100px;
            padding: 10px 20px;
            font-weight: 600;
        }

        .stream-header {
            background: var(--input-bg);
            padding: 8px 15px;
            border-bottom: 1px solid var(--input-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stream-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        .close-stream {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-stream:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .stream-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stream-info {
            background: var(--input-bg);
            padding: 6px 12px;
            border-bottom: 1px solid var(--input-border);
            font-size: 0.8rem;
            color: var(--text-primary);
        }
        
        .stream-info-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .stream-info-main {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
        }
        
        .stream-location {
            font-weight: 500;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .stream-info-details {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .stream-update-time {
            white-space: nowrap;
        }
        
        .stream-connection-status {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 6px;
            transition: background-color 0.2s ease;
            font-family: monospace;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 0.9rem;
            max-width: 300px;
            word-wrap: break-word;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 12px;
            padding: 0;
            line-height: 1;
        }

        .notification .close-btn:hover {
            opacity: 0.8;
        }

        .notification.error {
            background: #dc3545;
        }
        
        .copy-btn:hover {
            background: #5a6268;
        }
        
        .copy-btn:active {
            background: #495057;
        }
        
        .copyable-text {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stream-command {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #495057;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stream-output {
            flex: 1;
            background: #1e1e1e;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 15px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .stream-output::-webkit-scrollbar {
            width: 8px;
        }

        .stream-output::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .stream-output::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .stream-output::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .stream-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .stream-status.connected {
            background: #28a745;
        }

        .stream-status.disconnected {
            background: #dc3545;
        }

        .stream-status.paused {
            background: #ffc107;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem 1.5rem;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .header p {
                font-size: 0.85rem;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-end;
            }
            
            .status-item {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .create-session-btn {
                min-width: auto;
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .refresh-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .sessions-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .details-panel {
                max-height: 70vh;
            }

            .detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .detail-value {
                text-align: left;
            }

            .stream-panel {
                width: 100%;
                height: 50%;
                bottom: 0;
                transform: translateY(100%);
            }

            .stream-panel.open {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="notificationContainer"></div>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>tmux-util</h1>
                <p>Session Manager</p>
            </div>
            <div class="header-actions">
                <div class="status-item">
                    <span id="sessionCount">Loading sessions...</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="serviceStatus"></div>
                    <span id="serviceStatusText">Checking service status...</span>
                </div>

                <button class="create-session-btn" onclick="openCreateSessionModal()" title="Create New Session">
                    <span>‚ûï</span>
                    Create Session
                </button>
                <button class="refresh-btn" onclick="loadSessions()" title="Refresh sessions">
                    üîÑ
                </button>
                <button class="btn btn-secondary dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <span class="dark-mode-icon">üåô</span>
                    <span class="light-mode-icon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Messages -->
            <div id="messages"></div>

            <!-- Prominent Create Session Section (shown when no sessions) -->
            <div class="create-session-section" id="createSessionProminent" style="display: none;">
                <h3>üöÄ Get Started with tmux-util</h3>
                <p>Create your first tmux session to start managing your terminal workflows efficiently.</p>
                <button class="create-session-prominent" onclick="openCreateSessionModal()">
                    <span>‚ûï</span>
                    Create Your First Session
                </button>
            </div>

            <!-- Sessions Section -->
            <div class="section">
                <div style="margin-bottom: 1.5rem;">
                    <h2>Active Sessions</h2>
                </div>
                <div id="sessionsContainer">
                    <div class="loading">Loading sessions...</div>
                </div>
            </div>
        </div>
    </div>



    <!-- Panel Status Indicator -->
    <div class="panel-status" id="panelStatus">
        Panels are open - Use Quick Actions to manage
    </div>

    <!-- Create Session Modal -->
    <div class="modal" id="createSessionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Session</h3>
                <button class="modal-close" onclick="closeCreateSessionModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalSessionName">Session Name</label>
                    <input type="text" id="modalSessionName" class="form-control" placeholder="Enter a unique session name" required>
                </div>
                <div class="form-group">
                    <label for="modalFriendlyName">Friendly Name</label>
                    <input type="text" id="modalFriendlyName" class="form-control" placeholder="Display name for the session (optional)">
                </div>
                <div class="form-group">
                    <label for="modalWorkingDir">Working Directory</label>
                    <input type="text" id="modalWorkingDir" class="form-control" placeholder="/path/to/directory (optional)" list="directorySuggestions" autocomplete="off">
                    <datalist id="directorySuggestions"></datalist>
                </div>
                <div class="form-group">
                    <label for="modalStartCommand">Start Command</label>
                    <input type="text" id="modalStartCommand" class="form-control" placeholder="Command to run when session starts (optional)">
                </div>
                <div class="form-group">
                    <label for="modalWindowName">Initial Window Name</label>
                    <input type="text" id="modalWindowName" class="form-control" placeholder="Name for the first window (optional)">
                </div>
                <div class="form-group">
                    <label for="modalDetached">
                        <input type="checkbox" id="modalDetached" checked>
                        Start detached (don't attach to session immediately)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateSessionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createSessionFromModal()">Create Session</button>
            </div>
        </div>
    </div>

    <!-- Rename Pane Modal -->
    <div class="modal" id="renamePaneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rename Pane</h3>
                <button class="modal-close" onclick="closeRenamePaneModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalPaneName">Pane Name:</label>
                    <input type="text" id="modalPaneName" class="form-control" placeholder="Enter pane name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRenamePaneModal()">Cancel</button>
                <button class="btn btn-primary" onclick="renamePaneFromModal()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Delete Pane Modal -->
    <div class="modal" id="deletePaneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Pane</h3>
                <button class="modal-close" onclick="closeDeletePaneModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p id="deletePaneMessage">Are you sure you want to delete this pane?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeletePaneModal()">Cancel</button>
                <button class="btn btn-danger" onclick="deletePaneFromModal()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Rename Window Modal -->
    <div class="modal" id="renameWindowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rename Window</h3>
                <button class="modal-close" onclick="closeRenameWindowModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalWindowName">Window Name:</label>
                    <input type="text" id="modalWindowName" class="form-control" placeholder="Enter window name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRenameWindowModal()">Cancel</button>
                <button class="btn btn-primary" onclick="renameWindowFromModal()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Delete Window Modal -->
    <div class="modal" id="deleteWindowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Window</h3>
                <button class="modal-close" onclick="closeDeleteWindowModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p id="deleteWindowMessage">Are you sure you want to delete this window?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteWindowModal()">Cancel</button>
                <button class="btn btn-danger" onclick="deleteWindowFromModal()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Session Modal -->
    <div class="modal" id="deleteSessionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Session</h3>
                <button class="modal-close" onclick="closeDeleteSessionModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p id="deleteSessionMessage">Are you sure you want to delete this session?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteSessionModal()">Cancel</button>
                <button class="btn btn-danger" onclick="deleteSessionFromModal()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Current Pane Modal -->
    <div class="modal" id="deleteCurrentPaneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Current Pane</h3>
                <button class="modal-close" onclick="closeDeleteCurrentPaneModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p id="deleteCurrentPaneMessage">Are you sure you want to delete the current pane?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteCurrentPaneModal()">Cancel</button>
                <button class="btn btn-danger" onclick="deleteCurrentPaneFromModal()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Friendly Name Modal -->
    <div class="modal" id="editFriendlyNameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Friendly Name</h3>
                <button class="modal-close" onclick="closeEditFriendlyNameModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalFriendlyName">Friendly Name:</label>
                    <input type="text" id="modalFriendlyName" class="form-control" placeholder="Enter friendly name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditFriendlyNameModal()">Cancel</button>
                <button class="btn btn-primary" onclick="editFriendlyNameFromModal()">Save</button>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="quick-actions" id="quickActions">
        <div class="action-buttons">
            <button class="action-btn secondary" onclick="closeAllPanels()">Close All</button>
            <button class="action-btn" onclick="minimizePanels()">Minimize</button>
        </div>
    </div>

    <!-- Right Details Panel -->
    <div class="right-panel" id="rightPanel">
        <div class="details-header">
            <div class="header-content">
                <!-- Row 1: Names and Status -->
                <div class="header-row">
                    <div class="status-and-names">
                        <div class="name-section">
                            <div class="name-item" id="friendlyNameContainer" style="display: none;">
                                <span class="name-value" id="rightPanelSessionId"></span>
                                <button class="copy-btn" onclick="copyToClipboard(document.getElementById('rightPanelSessionId').textContent, event)" title="Copy friendly name">Copy</button>
                            </div>
                            <div class="name-item">
                                <span class="name-value" id="rightPanelTitle"></span>
                                <button class="copy-btn" onclick="copyToClipboard(document.getElementById('rightPanelTitle').textContent, event)" title="Copy name">Copy</button>
                            </div>
                        </div>
                        <div class="details-status" id="rightPanelStatus"></div>
                    </div>
                </div>
                
                <!-- Row 3: Created and Uptime -->
                <div class="header-row">
                    <div class="session-meta" id="rightPanelMeta"></div>
                </div>
                
                <!-- Row 4: Window Dropdown and Controls -->
                <div class="header-row" id="windowDropdownContainer" style="display: none;">
                    <div class="window-section">
                        <select id="windowSelect" onchange="showSelectedWindow()" class="window-dropdown" style="min-width: 200px;">
                            <option value="">Choose a window...</option>
                        </select>
                        <div class="window-controls" id="windowControlsRow" style="display: none;">
                            <button class="btn btn-primary btn-sm" id="activateWindowBtn" onclick="activateCurrentWindow(currentSession?.name)" title="Activate selected window" style="display: none;">
                                Activate
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="renameCurrentWindow(currentSession?.name)" title="Rename current window">
                                Rename
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="killCurrentWindow(currentSession?.name)" title="Kill current window">
                                Kill
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="createNewWindow(currentSession?.name)" title="Create new window">
                                New Window
                            </button>
                        </div>
                    </div>
                </div>
                

            </div>
            <button class="close-details" onclick="closeRightPanel()">√ó</button>
        </div>
        <div class="details-content" id="rightPanelContent">
            <!-- Details content will be populated here -->
        </div>
        
        <!-- Stream Panel (nested in right panel) -->
        <div class="stream-panel" id="streamPanel">
            <div class="stream-header">
                <div class="stream-title" id="streamTitle">Pane Stream</div>
                <div class="stream-controls">
                    <button class="btn btn-sm btn-secondary" onclick="toggleStream()" id="toggleStreamBtn">Pause</button>
                    <button class="btn btn-sm btn-secondary" onclick="refreshStream()" id="refreshStreamBtn">Refresh</button>
                    <button class="close-stream" onclick="closeStreamPanel()">√ó</button>
                </div>
            </div>
            <div class="stream-content">
                <div class="stream-info" id="streamInfo">
                    <!-- Stream info will be populated here -->
                </div>
                <div class="stream-output" id="streamOutput">
                    <!-- Stream content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        console.log('API_BASE:', API_BASE);
        console.log('Current URL:', window.location.href);
        let sessions = [];
        let currentSession = null;
        let currentStream = null;
        let streamEventSource = null;
        let isStreamPaused = false;
        let lastSelectedWindows = {}; // Track last selected window per session

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkServiceStatus();
            loadSessions();
            initDirectoryAutocomplete();
            initDarkMode();
            
            // Add keyboard support for closing panels
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeTopPanel();
                }
            });
            
            // Add scroll event handling for context-aware scrolling
            setupScrollHandling();
        });

        // Setup scroll handling for context-aware scrolling
        function setupScrollHandling() {
            const detailsContent = document.getElementById('rightPanelContent');
            const streamContent = document.getElementById('streamOutput');
            
            // Handle scroll events on details content
            if (detailsContent) {
                detailsContent.addEventListener('wheel', function(event) {
                    const element = event.currentTarget;
                    const scrollTop = element.scrollTop;
                    const scrollHeight = element.scrollHeight;
                    const clientHeight = element.clientHeight;
                    
                    // Check if we're at the top or bottom of the scrollable area
                    const isAtTop = scrollTop === 0;
                    const isAtBottom = scrollTop + clientHeight >= scrollHeight;
                    
                    // If scrolling up at the top or down at the bottom, prevent default
                    // to allow the scroll to bubble up to the main page
                    if ((event.deltaY < 0 && isAtTop) || (event.deltaY > 0 && isAtBottom)) {
                        event.preventDefault();
                        // Let the scroll event bubble up to the main page
                        return;
                    }
                    
                    // Otherwise, let the panel handle the scroll
                    event.stopPropagation();
                });
            }
            
            // Handle scroll events on stream content
            if (streamContent) {
                streamContent.addEventListener('wheel', function(event) {
                    const element = event.currentTarget;
                    const scrollTop = element.scrollTop;
                    const scrollHeight = element.scrollHeight;
                    const clientHeight = element.clientHeight;
                    
                    // Check if we're at the top or bottom of the scrollable area
                    const isAtTop = scrollTop === 0;
                    const isAtBottom = scrollTop + clientHeight >= scrollHeight;
                    
                    // If scrolling up at the top or down at the bottom, prevent default
                    // to allow the scroll to bubble up to the main page
                    if ((event.deltaY < 0 && isAtTop) || (event.deltaY > 0 && isAtBottom)) {
                        event.preventDefault();
                        // Let the scroll event bubble up to the main page
                        return;
                    }
                    
                    // Otherwise, let the panel handle the scroll
                    event.stopPropagation();
                });
            }
        }

        // Check service status
        async function checkServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusIndicator = document.getElementById('serviceStatus');
                const statusText = document.getElementById('serviceStatusText');
                
                if (response.ok) {
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = `Service healthy (uptime: ${Math.round(data.uptime)}s)`;
                } else {
                    throw new Error('Service unhealthy');
                }
            } catch (error) {
                const statusIndicator = document.getElementById('serviceStatus');
                const statusText = document.getElementById('serviceStatusText');
                
                statusIndicator.className = 'status-indicator error';
                statusText.textContent = 'Service unavailable';
            }
        }

        // Load all sessions
        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/tmux/sessions`);
                const data = await response.json();
                
                if (data.success) {
                    sessions = data.sessions;
                    displaySessions();
                    updateSessionCount();
                } else {
                    showError('Failed to load sessions: ' + data.error);
                }
            } catch (error) {
                showError('Failed to connect to service: ' + error.message);
            }
        }

        // Display sessions in the UI
        function displaySessions() {
            const container = document.getElementById('sessionsContainer');
            const prominentSection = document.getElementById('createSessionProminent');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="loading">No active sessions found</div>';
                prominentSection.style.display = 'block';
                return;
            }

            prominentSection.style.display = 'none';
            const sessionsHTML = sessions.map(session => `
                <div class="session-card ${session.attached ? 'attached' : ''}">
                    <div class="session-header">
                        <div class="session-name-section">
                            <div class="session-name">
                                ${session.friendly_name || session.name}
                                <button class="copy-btn" onclick="copyToClipboard('${session.friendly_name || session.name}', event)" title="Copy session name">Copy</button>
                            </div>
                            ${session.friendly_name ? `<div class="session-original-name">${session.name} <button class="copy-btn" onclick="copyToClipboard('${session.name}', event)" title="Copy session ID">Copy</button></div>` : ''}
                        </div>
                        <div class="session-status ${session.attached ? 'attached' : 'detached'}">
                            ${session.attached ? 'Attached' : 'Detached'}
                        </div>
                    </div>
                    <div class="session-details">
                        <div>Windows: ${session.windows}</div>
                        <div>Created: ${new Date(session.created).toLocaleString()}</div>
                        ${session.active_window ? `
                        <div class="active-window">
                            <strong>Active Window:</strong> ${session.active_window.name}
                        </div>
                        ` : ''}

                        <div class="session-stats">
                            <small>Click "Details" to see pane information</small>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="editFriendlyName('${session.name}', '${session.friendly_name || ''}')">
                            ${session.friendly_name ? 'Edit Name' : 'Add Name'}
                        </button>
                        <button class="btn btn-danger" onclick="killSession('${session.name}')">
                            Kill Session
                        </button>
                        <button class="btn btn-primary" onclick="openDetailsPanel('${session.name}')">
                            Details
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="sessions-grid">${sessionsHTML}</div>`;
            

        }

        // Update session count
        function updateSessionCount() {
            const countElement = document.getElementById('sessionCount');
            countElement.textContent = `${sessions.length} session(s)`;
        }



        // Open create session modal
        function openCreateSessionModal() {
            const modal = document.getElementById('createSessionModal');
            const input = document.getElementById('modalSessionName');
            
            modal.classList.add('show');
            input.focus();
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeCreateSessionModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close create session modal
        function closeCreateSessionModal() {
            const modal = document.getElementById('createSessionModal');
            const sessionNameInput = document.getElementById('modalSessionName');
            const workingDirInput = document.getElementById('modalWorkingDir');
            const startCommandInput = document.getElementById('modalStartCommand');
            const windowNameInput = document.getElementById('modalWindowName');
            const friendlyNameInput = document.getElementById('modalFriendlyName');
            const detachedCheckbox = document.getElementById('modalDetached');
            
            modal.classList.remove('show');
            sessionNameInput.value = '';
            workingDirInput.value = '';
            startCommandInput.value = '';
            windowNameInput.value = '';
            friendlyNameInput.value = '';
            detachedCheckbox.checked = true;
        }

        // Create session from modal
        async function createSessionFromModal() {
            const sessionName = document.getElementById('modalSessionName').value.trim();
            const workingDir = document.getElementById('modalWorkingDir').value.trim();
            const startCommand = document.getElementById('modalStartCommand').value.trim();
            const windowName = document.getElementById('modalWindowName').value.trim();
            const friendlyName = document.getElementById('modalFriendlyName').value.trim();
            const detached = document.getElementById('modalDetached').checked;
            
            if (!sessionName) {
                showError('Please enter a session name');
                return;
            }

            try {
                // Step 1: Create basic session
                console.log('Step 1: Creating basic session');
                let createCommand = `new-session`;
                if (detached) {
                    createCommand += ` -d`;
                }
                createCommand += ` -s "${sessionName}"`;
                
                const createResponse = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: createCommand
                    })
                });
                
                const createData = await createResponse.json();
                if (!createData.success) {
                    showError('Failed to create session: ' + (createData.error || 'Unknown error'));
                    return;
                }
                console.log('Session created successfully');
                
                // Step 2: Set working directory if specified
                if (workingDir) {
                    try {
                        console.log('Step 2: Setting working directory to:', workingDir);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const cdResponse = await fetch(`${API_BASE}/tmux/command`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                session: sessionName,
                                command: `send-keys -t ${sessionName}:0 "cd ${workingDir}" C-m`
                            })
                        });
                        
                        const cdData = await cdResponse.json();
                        if (!cdData.success) {
                            console.warn('Failed to set working directory:', cdData.error);
                        } else {
                            console.log('Working directory set successfully');
                        }
                    } catch (error) {
                        console.warn('Failed to set working directory:', error);
                    }
                }
                
                // Step 3: Rename window if specified
                if (windowName) {
                    try {
                        console.log('Step 3: Renaming window to:', windowName);
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                        const renameResponse = await fetch(`${API_BASE}/tmux/command`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                session: sessionName,
                                command: `rename-window -t ${sessionName}:0 "${windowName}"`
                            })
                        });
                        
                        const renameData = await renameResponse.json();
                        if (!renameData.success) {
                            console.warn('Failed to rename window:', renameData.error);
                        } else {
                            console.log('Window renamed successfully');
                        }
                    } catch (error) {
                        console.warn('Failed to rename window:', error);
                    }
                }
                
                // Step 4: Run start command if specified
                if (startCommand) {
                    try {
                        console.log('Step 4: Running start command:', startCommand);
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                        const cmdResponse = await fetch(`${API_BASE}/tmux/command`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                session: sessionName,
                                command: `send-keys -t ${sessionName}:0 "${startCommand}" C-m`
                            })
                        });
                        
                        const cmdData = await cmdResponse.json();
                        if (!cmdData.success) {
                            console.warn('Failed to run start command:', cmdData.error);
                        } else {
                            console.log('Start command executed successfully');
                        }
                    } catch (error) {
                        console.warn('Failed to run start command:', error);
                    }
                }
                
                // Set friendly name if provided
                if (friendlyName) {
                    try {
                        await fetch(`${API_BASE}/tmux/session-names/${sessionName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ friendly_name: friendlyName })
                        });
                    } catch (error) {
                        console.warn('Failed to set friendly name:', error);
                    }
                }
                
                showSuccess(`Session '${sessionName}' created successfully`);
                closeCreateSessionModal();
                loadSessions();
            } catch (error) {
                showError('Failed to create session: ' + error.message);
            }
        }

        // Legacy function for backward compatibility
        async function createSession() {
            openCreateSessionModal();
        }

        // Global variables for modals
        let renamePaneData = null;
        let deletePaneData = null;
        let renameWindowData = null;
        let deleteWindowData = null;
        let deleteSessionData = null;
        let deleteCurrentPaneData = null;
        let editFriendlyNameData = null;

        // Open rename pane modal
        function openRenamePaneModal(sessionName, windowIndex, paneIndex, currentName) {
            const modal = document.getElementById('renamePaneModal');
            const input = document.getElementById('modalPaneName');
            
            // Store the pane data for use in the rename function
            renamePaneData = { sessionName, windowIndex, paneIndex };
            
            // Set the current name as the input value
            input.value = currentName;
            
            modal.classList.add('show');
            input.focus();
            input.select(); // Select all text for easy editing
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeRenamePaneModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close rename pane modal
        function closeRenamePaneModal() {
            const modal = document.getElementById('renamePaneModal');
            const input = document.getElementById('modalPaneName');
            
            modal.classList.remove('show');
            input.value = '';
            renamePaneData = null;
        }

        // Rename pane from modal
        async function renamePaneFromModal() {
            if (!renamePaneData) {
                showError('No pane data available');
                return;
            }
            
            const { sessionName, windowIndex, paneIndex } = renamePaneData;
            const newName = document.getElementById('modalPaneName').value.trim();
            
            if (!newName) {
                showError('Please enter a pane name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `select-pane -t ${sessionName}:${windowIndex}.${paneIndex} -T "${newName}"`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Pane renamed to '${newName}'`);
                    closeRenamePaneModal();
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to rename pane: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to rename pane: ' + error.message);
            }
        }

        // Open delete pane modal
        function openDeletePaneModal(sessionName, windowIndex, paneIndex, paneName) {
            const modal = document.getElementById('deletePaneModal');
            const message = document.getElementById('deletePaneMessage');
            
            // Store the pane data for use in the delete function
            deletePaneData = { sessionName, windowIndex, paneIndex };
            
            // Set the confirmation message
            message.textContent = `Are you sure you want to delete pane "${paneName}"?`;
            
            modal.classList.add('show');
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeDeletePaneModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close delete pane modal
        function closeDeletePaneModal() {
            const modal = document.getElementById('deletePaneModal');
            
            modal.classList.remove('show');
            deletePaneData = null;
        }

        // Delete pane from modal
        async function deletePaneFromModal() {
            if (!deletePaneData) {
                showError('No pane data available');
                return;
            }
            
            const { sessionName, windowIndex, paneIndex } = deletePaneData;

            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `kill-pane -t ${sessionName}:${windowIndex}.${paneIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Pane deleted successfully`);
                    closeDeletePaneModal();
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to delete pane: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to delete pane: ' + error.message);
            }
        }

        // Open rename window modal
        function openRenameWindowModal(sessionName, windowIndex, currentName) {
            const modal = document.getElementById('renameWindowModal');
            const input = document.getElementById('modalWindowName');
            
            // Store the window data for use in the rename function
            renameWindowData = { sessionName, windowIndex };
            
            // Set the current name as the input value
            input.value = currentName;
            
            modal.classList.add('show');
            input.focus();
            input.select(); // Select all text for easy editing
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeRenameWindowModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close rename window modal
        function closeRenameWindowModal() {
            const modal = document.getElementById('renameWindowModal');
            const input = document.getElementById('modalWindowName');
            
            modal.classList.remove('show');
            input.value = '';
            renameWindowData = null;
        }

        // Rename window from modal
        async function renameWindowFromModal() {
            if (!renameWindowData) {
                showError('No window data available');
                return;
            }
            
            const { sessionName, windowIndex } = renameWindowData;
            const newName = document.getElementById('modalWindowName').value.trim();
            
            if (!newName) {
                showError('Please enter a window name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `rename-window -t ${sessionName}:${windowIndex} "${newName}"`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Window renamed to '${newName}'`);
                    closeRenameWindowModal();
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to rename window: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to rename window: ' + error.message);
            }
        }

        // Open delete window modal
        function openDeleteWindowModal(sessionName, windowIndex, windowName) {
            const modal = document.getElementById('deleteWindowModal');
            const message = document.getElementById('deleteWindowMessage');
            
            // Store the window data for use in the delete function
            deleteWindowData = { sessionName, windowIndex };
            
            // Set the confirmation message
            message.textContent = `Are you sure you want to delete window "${windowName}"?`;
            
            modal.classList.add('show');
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeDeleteWindowModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close delete window modal
        function closeDeleteWindowModal() {
            const modal = document.getElementById('deleteWindowModal');
            
            modal.classList.remove('show');
            deleteWindowData = null;
        }

        // Delete window from modal
        async function deleteWindowFromModal() {
            if (!deleteWindowData) {
                showError('No window data available');
                return;
            }
            
            const { sessionName, windowIndex } = deleteWindowData;

            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `kill-window -t ${sessionName}:${windowIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Window deleted successfully`);
                    closeDeleteWindowModal();
                    
                    // Check if this was the last window in the session
                    if (currentSession.windows_info.length === 1) {
                        // This was the last window, session will be deleted
                        showSuccess('Last window deleted - session deleted');
                        closeRightPanel();
                        // Refresh the sessions list to remove the deleted session
                        loadSessions();
                    } else {
                        // Still have other windows, refresh session info
                        getSessionInfo(sessionName);
                    }
                } else {
                    showError('Failed to delete window: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to delete window: ' + error.message);
            }
        }

        // Open delete session modal
        function openDeleteSessionModal(sessionName) {
            const modal = document.getElementById('deleteSessionModal');
            const message = document.getElementById('deleteSessionMessage');
            
            // Store the session data for use in the delete function
            deleteSessionData = { sessionName };
            
            // Set the confirmation message
            message.textContent = `Are you sure you want to delete session "${sessionName}"?`;
            
            modal.classList.add('show');
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeDeleteSessionModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close delete session modal
        function closeDeleteSessionModal() {
            const modal = document.getElementById('deleteSessionModal');
            
            modal.classList.remove('show');
            deleteSessionData = null;
        }

        // Delete session from modal
        async function deleteSessionFromModal() {
            if (!deleteSessionData) {
                showError('No session data available');
                return;
            }
            
            const { sessionName } = deleteSessionData;

            try {
                const response = await fetch(`${API_BASE}/tmux/kill/${sessionName}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    closeDeleteSessionModal();
                    loadSessions();
                } else {
                    showError('Failed to delete session: ' + data.error);
                }
            } catch (error) {
                showError('Failed to delete session: ' + error.message);
            }
        }

        // Open delete current pane modal
        function openDeleteCurrentPaneModal(sessionName, windowIndex, windowName) {
            const modal = document.getElementById('deleteCurrentPaneModal');
            const message = document.getElementById('deleteCurrentPaneMessage');
            
            // Store the pane data for use in the delete function
            deleteCurrentPaneData = { sessionName, windowIndex };
            
            // Set the confirmation message
            message.textContent = `Are you sure you want to kill the current pane in window "${windowName}"?`;
            
            modal.classList.add('show');
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeDeleteCurrentPaneModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close delete current pane modal
        function closeDeleteCurrentPaneModal() {
            const modal = document.getElementById('deleteCurrentPaneModal');
            
            modal.classList.remove('show');
            deleteCurrentPaneData = null;
        }

        // Delete current pane from modal
        async function deleteCurrentPaneFromModal() {
            if (!deleteCurrentPaneData) {
                showError('No pane data available');
                return;
            }
            
            const { sessionName, windowIndex } = deleteCurrentPaneData;

            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `kill-pane -t ${sessionName}:${windowIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Current pane killed successfully');
                    closeDeleteCurrentPaneModal();
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to kill pane: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to kill pane: ' + error.message);
            }
        }

        // Open edit friendly name modal
        function openEditFriendlyNameModal(sessionName, currentName) {
            const modal = document.getElementById('editFriendlyNameModal');
            const input = document.getElementById('modalFriendlyName');
            
            // Store the session data for use in the edit function
            editFriendlyNameData = { sessionName };
            
            // Set the current name as the input value
            input.value = currentName || '';
            
            modal.classList.add('show');
            input.focus();
            input.select(); // Select all text for easy editing
            
            // Add escape key listener
            const escapeHandler = function(event) {
                if (event.key === 'Escape') {
                    closeEditFriendlyNameModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Close edit friendly name modal
        function closeEditFriendlyNameModal() {
            const modal = document.getElementById('editFriendlyNameModal');
            const input = document.getElementById('modalFriendlyName');
            
            modal.classList.remove('show');
            input.value = '';
            editFriendlyNameData = null;
        }

        // Edit friendly name from modal
        async function editFriendlyNameFromModal() {
            if (!editFriendlyNameData) {
                showError('No session data available');
                return;
            }
            
            const { sessionName } = editFriendlyNameData;
            const newName = document.getElementById('modalFriendlyName').value.trim();
            
            if (newName === '') {
                // Remove friendly name
                removeFriendlyName(sessionName);
                closeEditFriendlyNameModal();
                return;
            }
            
            setFriendlyName(sessionName, newName);
            closeEditFriendlyNameModal();
        }

        // Directory autocomplete functionality
        let directorySearchTimeout = null;

        // Initialize dark mode
        function initDarkMode() {
            // Check for saved theme preference or default to light mode
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Toggle dark mode
        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Initialize directory autocomplete
        function initDirectoryAutocomplete() {
            const workingDirInput = document.getElementById('modalWorkingDir');
            if (workingDirInput) {
                workingDirInput.addEventListener('input', handleDirectoryInput);
                workingDirInput.addEventListener('focus', () => loadDirectorySuggestions(''));
                
                // Add event listener for when user selects an option from datalist
                workingDirInput.addEventListener('change', handleDirectorySelection);
            }
        }

        // Handle directory input changes
        function handleDirectoryInput(event) {
            const query = event.target.value;
            
            // Clear previous timeout
            if (directorySearchTimeout) {
                clearTimeout(directorySearchTimeout);
            }
            
            // Debounce the search to avoid too many requests
            directorySearchTimeout = setTimeout(() => {
                loadDirectorySuggestions(query);
            }, 300);
        }

        // Handle directory selection from datalist
        function handleDirectorySelection(event) {
            const selectedValue = event.target.value;
            
            // If the selected value doesn't end with '/', add it
            if (selectedValue && !selectedValue.endsWith('/')) {
                event.target.value = selectedValue + '/';
                
                // Trigger input event to load suggestions for the new path
                setTimeout(() => {
                    const inputEvent = new Event('input', { bubbles: true });
                    event.target.dispatchEvent(inputEvent);
                }, 100);
            }
        }

        // Load directory suggestions
        async function loadDirectorySuggestions(query) {
            try {
                const datalist = document.getElementById('directorySuggestions');
                if (!datalist) return;

                // Clear existing options
                datalist.innerHTML = '';

                if (!query || query.trim() === '') {
                    // If no query, show common directories
                    const commonDirs = ['/home', '/var', '/etc', '/usr', '/opt', '/tmp', '/root'];
                    commonDirs.forEach(dir => {
                        const option = document.createElement('option');
                        option.value = dir;
                        option.textContent = dir;
                        datalist.appendChild(option);
                    });
                    return;
                }

                // Determine the base path and search term
                let basePath = '/';
                let searchTerm = query;
                
                if (query.startsWith('/')) {
                    const lastSlashIndex = query.lastIndexOf('/');
                    if (lastSlashIndex === 0) {
                        // Just "/" - search in root
                        basePath = '/';
                        searchTerm = '';
                    } else if (lastSlashIndex > 0) {
                        // Has path components
                        basePath = query.substring(0, lastSlashIndex);
                        searchTerm = query.substring(lastSlashIndex + 1);
                    }
                } else {
                    // Relative path - search in current working directory
                    basePath = process.cwd ? process.cwd() : '/home';
                    searchTerm = query;
                }

                const response = await fetch(`${API_BASE}/api/directories?path=${encodeURIComponent(basePath)}&query=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();

                if (data.success) {
                    // Add suggestions based on the current input
                    data.directories.forEach(dir => {
                        const option = document.createElement('option');
                        
                        if (query.startsWith('/')) {
                            // Absolute path
                            option.value = dir.fullPath;
                            option.textContent = dir.fullPath;
                        } else {
                            // Relative path
                            option.value = dir.name;
                            option.textContent = dir.name;
                        }
                        
                        datalist.appendChild(option);
                    });

                    // If no results and user is typing a path, try to complete the path
                    if (data.directories.length === 0 && query.includes('/')) {
                        const pathParts = query.split('/');
                        const partialPath = pathParts.slice(0, -1).join('/');
                        const partialSearch = pathParts[pathParts.length - 1];
                        
                        if (partialPath && partialSearch) {
                            try {
                                const partialResponse = await fetch(`${API_BASE}/api/directories?path=${encodeURIComponent(partialPath)}&query=${encodeURIComponent(partialSearch)}`);
                                const partialData = await partialResponse.json();
                                
                                if (partialData.success && partialData.directories.length > 0) {
                                    partialData.directories.forEach(dir => {
                                        const option = document.createElement('option');
                                        option.value = dir.fullPath;
                                        option.textContent = dir.fullPath;
                                        datalist.appendChild(option);
                                    });
                                }
                            } catch (error) {
                                console.error('Error loading partial path suggestions:', error);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading directory suggestions:', error);
            }
        }

        // Kill a session
        async function killSession(sessionName) {
            openDeleteSessionModal(sessionName);
        }

        // Get session info
        async function getSessionInfo(sessionName) {
            console.log('Getting session info for:', sessionName);
            const url = `${API_BASE}/tmux/sessions/${sessionName}`;
            console.log('Fetching URL:', url);
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Session info response:', data);
                
                if (data.success) {
                    // If stream panel is open for a different session, close it
                    if (currentStream && currentStream.session !== sessionName) {
                        closeStreamPanel();
                    }
                    
                    currentSession = data.session;
                    console.log('Current session set:', currentSession);
                    showRightPanel();
                } else {
                    showError('Failed to get session info: ' + data.error);
                }
            } catch (error) {
                console.error('Error getting session info:', error);
                showError('Failed to get session info: ' + error.message);
            }
        }

        // Show right panel with session details
        function showRightPanel() {
            console.log('showRightPanel called, currentSession:', currentSession);
            if (!currentSession) {
                console.log('No current session, returning');
                return;
            }
            
            const title = document.getElementById('rightPanelTitle');
            const content = document.getElementById('rightPanelContent');
            const panel = document.getElementById('rightPanel');
            
            title.textContent = `Session: ${currentSession.friendly_name || currentSession.name}`;
            
            // Update stream panel if it's open for the same session
            if (currentStream && currentStream.session === currentSession.name) {
                updateStreamPanelDisplay();
            }
            
            let windowsHtml = '';
            if (currentSession.windows_info && currentSession.windows_info.length > 0) {
                windowsHtml = `
                    <div class="detail-item">
                        <div class="detail-value">
                            <div id="selectedWindowContent" class="selected-window-content">
                                <p class="no-window-selected">Select a window from the dropdown in the header to view its panes.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                windowsHtml = `
                    <div class="detail-item">
                        <div class="detail-value">No windows available</div>
                    </div>
                `;
            }

            content.innerHTML = windowsHtml;
            
            // Update header with session info
            const titleElement = document.getElementById('rightPanelTitle');
            const sessionIdElement = document.getElementById('rightPanelSessionId');
            const metaElement = document.getElementById('rightPanelMeta');
            const statusElement = document.getElementById('rightPanelStatus');
            const friendlyNameContainer = document.getElementById('friendlyNameContainer');
            
            // Set session name (always show the actual name)
            titleElement.textContent = currentSession.name;
            
            // Show friendly name if it exists and is different from the actual name
            if (currentSession.friendly_name && currentSession.friendly_name !== currentSession.name) {
                sessionIdElement.textContent = currentSession.friendly_name;
                friendlyNameContainer.style.display = 'flex';
            } else {
                friendlyNameContainer.style.display = 'none';
            }
            
            metaElement.innerHTML = `
                <div class="meta-item">Created: ${new Date(currentSession.created).toLocaleString()} | Uptime: ${getUptime(currentSession.created)}</div>
            `;
            statusElement.innerHTML = `<span class="detail-status ${currentSession.attached ? 'attached' : 'detached'}">${currentSession.attached ? 'Attached' : 'Detached'}</span>`;
            
            panel.classList.add('open');
            document.body.classList.add('right-panel-open');
            
            // Populate and show window dropdown in header
            const windowDropdownContainer = document.getElementById('windowDropdownContainer');
            const windowSelect = document.getElementById('windowSelect');
            const windowControlsRow = document.getElementById('windowControlsRow');
            
            if (currentSession.windows_info && currentSession.windows_info.length > 0) {
                // Determine which window to select by default
                let defaultWindowIndex = null;
                
                // If we have a last selected window for this session, try to use it
                if (lastSelectedWindows[currentSession.name]) {
                    const lastWindow = currentSession.windows_info.find(w => w.index === lastSelectedWindows[currentSession.name]);
                    if (lastWindow) {
                        defaultWindowIndex = lastSelectedWindows[currentSession.name];
                    }
                }
                
                // If no last selected window or it's not available, default to first window
                if (defaultWindowIndex === null && currentSession.windows_info.length > 0) {
                    defaultWindowIndex = currentSession.windows_info[0].index;
                }
                
                // Populate dropdown options
                windowSelect.innerHTML = `
                    <option value="">Choose a window...</option>
                    ${currentSession.windows_info.map((window) => `
                        <option value="${window.index}" ${window.index === defaultWindowIndex ? 'selected' : ''}>Window ${window.index}: ${window.name}${window.active ? ' (Active)' : ''}</option>
                    `).join('')}
                `;
                
                // Show the dropdown container
                windowDropdownContainer.style.display = 'block';
                
                // Auto-select the default window if available
                setTimeout(() => {
                    showSelectedWindow();
                }, 100); // Small delay to ensure DOM is ready
            } else {
                // Hide the dropdown container if no windows
                windowDropdownContainer.style.display = 'none';
            }
        }

        // Close right panel
        function closeRightPanel() {
            const panel = document.getElementById('rightPanel');
            
            panel.classList.remove('open');
            document.body.classList.remove('right-panel-open');
            currentSession = null;
            
            // Hide window dropdown and control rows
            const windowDropdownContainer = document.getElementById('windowDropdownContainer');
            const windowControlsRow = document.getElementById('windowControlsRow');
            
            if (windowDropdownContainer) windowDropdownContainer.style.display = 'none';
            if (windowControlsRow) windowControlsRow.style.display = 'none';
            
            // Also close stream panel if open
            closeStreamPanel();
        }

        // Close details panel (legacy function)
        function closeDetailsPanel() {
            closeRightPanel();
        }

        // Show selected window details
        function showSelectedWindow() {
            const select = document.getElementById('windowSelect');
            const content = document.getElementById('selectedWindowContent');
            
            if (!select || !content || !currentSession || !currentSession.windows_info) {
                return;
            }
            
            const selectedWindowIndex = parseInt(select.value);
            
            // Track the last selected window for this session
            if (!isNaN(selectedWindowIndex)) {
                lastSelectedWindows[currentSession.name] = selectedWindowIndex;
            }
            
            if (isNaN(selectedWindowIndex)) {
                content.innerHTML = '<p class="no-window-selected">Select a window from the dropdown in the header to view its panes.</p>';
                
                // Hide window controls when no window is selected
                const windowControlsRow = document.getElementById('windowControlsRow');
                
                if (windowControlsRow) windowControlsRow.style.display = 'none';
                
                return;
            }
            
            const window = currentSession.windows_info.find(w => w.index === selectedWindowIndex);
            
            if (!window) {
                content.innerHTML = '<p class="no-window-selected">Window not found.</p>';
                return;
            }
            
            // Show window controls when a window is selected
            const windowControlsRow = document.getElementById('windowControlsRow');
            const activateWindowBtn = document.getElementById('activateWindowBtn');
            
            if (windowControlsRow) windowControlsRow.style.display = 'flex';
            
            // Show/hide activate button based on whether window is already active
            if (activateWindowBtn) {
                if (window.active) {
                    activateWindowBtn.style.display = 'none';
                } else {
                    activateWindowBtn.style.display = 'inline-block';
                }
            }
            
            // Generate window content directly without making another API call
            let windowHtml = `
                <div class="window-info">
            `;
            
            if (window.panes && window.panes.length > 0) {
                const panesListHtml = window.panes.map(pane => `
                    <div class="pane-info ${pane.active ? 'pane-active' : ''}" onclick="streamPane('${currentSession.name}', ${window.index}, ${pane.index}, '${window.name}', ${pane.index}, '${pane.name || `Pane ${pane.index}`}')" style="cursor: pointer;">
                        <div class="pane-header">
                            <span class="pane-name">${pane.name || `Pane ${pane.index}`}</span>
                            <div class="pane-controls">
                                ${pane.active ? '<span class="pane-active-badge">Active</span>' : ''}
                                <span class="pane-stream-hint">Click to stream</span>
                                ${!pane.active ? `<button class="btn btn-primary btn-sm" onclick="activatePane('${currentSession.name}', ${window.index}, ${pane.index}, event)" title="Activate this pane" style="margin-left: 8px; padding: 2px 6px; font-size: 0.7rem;">
                                    Activate
                                </button>` : ''}
                                ${pane.active ? `
                                <button class="btn btn-primary btn-sm" onclick="splitPaneHorizontally('${currentSession.name}', event)" title="Split horizontally" style="margin-left: 8px; padding: 2px 6px; font-size: 0.7rem;">
                                    <span>‚ÜîÔ∏è</span> New Pane
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="splitPaneVertically('${currentSession.name}', event)" title="Split vertically" style="margin-left: 4px; padding: 2px 6px; font-size: 0.7rem;">
                                    <span>‚ÜïÔ∏è</span> New Pane
                                </button>
                                ` : ''}
                                <button class="btn btn-secondary btn-sm" onclick="renameSpecificPane('${currentSession.name}', ${window.index}, ${pane.index}, event)" title="Rename this pane" style="margin-left: 4px; padding: 2px 6px; font-size: 0.7rem;">
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="killSpecificPane('${currentSession.name}', ${window.index}, ${pane.index}, event)" title="Kill this pane" style="margin-left: 4px; padding: 2px 6px; font-size: 0.7rem;">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="pane-details">
                            <div class="pane-command">
                                <strong>Command:</strong> 
                                <div class="command-container">
                                    <span class="command-text">${pane.command || 'No command running'}</span>
                                    ${pane.command ? `<button class="copy-btn" onclick="copyToClipboard('${pane.command.replace(/'/g, "\\'")}', event)" title="Copy command">Copy</button>` : ''}
                                </div>
                            </div>
                            <div class="pane-path">
                                <strong>Path:</strong> 
                                <div class="command-container">
                                    <span class="path-text">${pane.path || 'No path'}</span>
                                    ${pane.path ? `<button class="copy-btn" onclick="copyToClipboard('${pane.path}', event)" title="Copy path">Copy</button>` : ''}
                                </div>
                            </div>
                            <div class="pane-pid">
                                <strong>PID:</strong> 
                                <div class="command-container">
                                    <span class="pid-text">${pane.pid || 'N/A'}</span>
                                    ${pane.pid ? `<button class="copy-btn" onclick="copyToClipboard('${pane.pid}', event)" title="Copy PID">Copy</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                windowHtml += `
                    <div class="panes-section">
                        <div class="panes-list">
                            ${panesListHtml}
                        </div>
                    </div>
                `;
            } else {
                windowHtml += '<p class="no-panes">No panes in this window.</p>';
            }
            
            windowHtml += '</div>';
            content.innerHTML = windowHtml;
        }







        // Calculate uptime
        function getUptime(createdDate) {
            const created = new Date(createdDate);
            const now = new Date();
            const diff = now - created;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Show success message
        function showSuccess(message) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success';
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="close-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // Copy text to clipboard
        async function copyToClipboard(text, event) {
            // Stop event propagation to prevent triggering parent click handlers
            if (event) {
                event.stopPropagation();
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showNotification('Copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Copied to clipboard!');
            }
        }

        // Show error message
        function showError(message) {
            showNotification(message, 'error');
        }

        // Stream pane content
        function streamPane(sessionName, windowIndex, paneIndex, windowName, paneNumber, paneName) {
            // Always close existing stream before starting a new one
            if (currentStream) {
                closeStreamPanel();
            }
            
            currentStream = {
                session: sessionName,
                window: windowIndex,
                pane: paneIndex,
                windowName: windowName,
                paneNumber: paneNumber,
                paneName: paneName
            };
            
            showStreamPanel();
            startStream();
            
            // Update command display immediately
            updateStreamCommand();
        }

        // Debounce function to prevent too frequent updates
        let updateDisplayTimeout = null;
        
        // Find common prefix between two strings
        function findCommonPrefix(str1, str2) {
            const minLength = Math.min(str1.length, str2.length);
            let commonLength = 0;
            
            for (let i = 0; i < minLength; i++) {
                if (str1[i] === str2[i]) {
                    commonLength++;
                } else {
                    break;
                }
            }
            
            return str1.substring(0, commonLength);
        }
        

        
        // Copy stream command
        function copyStreamCommand(event) {
            const commandElement = document.getElementById('streamCommand');
            if (commandElement && commandElement.textContent && commandElement.textContent !== 'Loading command...' && commandElement.textContent !== 'No command running' && commandElement.textContent !== 'Error loading command') {
                copyToClipboard(commandElement.textContent, event);
            }
        }

        // Update stream command display
        async function updateStreamCommand() {
            if (!currentStream) return;
            
            const commandElement = document.getElementById('streamCommand');
            const copyButton = document.getElementById('copyStreamCommand');
            if (!commandElement) return;
            
            try {
                // Get the command from the current session's pane data
                if (currentSession && currentSession.windows_info) {
                    const window = currentSession.windows_info[currentStream.window];
                    if (window && window.panes && window.panes[currentStream.pane]) {
                        const pane = window.panes[currentStream.pane];
                        if (pane.command && pane.command.trim()) {
                            commandElement.textContent = pane.command;
                            if (copyButton) copyButton.style.display = 'inline-block';
                            return;
                        }
                    }
                }
                
                // Fallback: fetch from API
                const response = await fetch(`${API_BASE}/tmux/sessions/${currentStream.session}/windows/${currentStream.window}/panes/${currentStream.pane}/content`);
                const data = await response.json();
                
                if (data.success && data.command) {
                    commandElement.textContent = data.command;
                    if (copyButton) copyButton.style.display = 'inline-block';
                } else {
                    commandElement.textContent = 'No command running';
                    if (copyButton) copyButton.style.display = 'none';
                }
            } catch (error) {
                commandElement.textContent = 'Error loading command';
                if (copyButton) copyButton.style.display = 'none';
            }
        }

        // Update stream panel display (without opening it)
        function updateStreamPanelDisplay() {
            if (!currentStream) return;
            
            // Debounce updates to prevent flickering
            if (updateDisplayTimeout) {
                clearTimeout(updateDisplayTimeout);
            }
            
            updateDisplayTimeout = setTimeout(() => {
                const title = document.getElementById('streamTitle');
                const timestamp = document.getElementById('streamTimestamp');
                
                if (title) {
                    title.textContent = `${currentStream.windowName}: ${currentStream.paneName}`;
                    console.log('updateStreamPanelDisplay: Updated title to:', title.textContent);
                }
                
                // Only update timestamp if it's been more than 5 seconds
                if (timestamp) {
                    const currentTime = new Date();
                    const lastUpdate = timestamp.dataset.lastUpdate ? new Date(timestamp.dataset.lastUpdate) : new Date(0);
                    if (currentTime - lastUpdate > 5000) {
                        timestamp.textContent = currentTime.toLocaleString();
                        timestamp.dataset.lastUpdate = currentTime.toISOString();
                    }
                }
            }, 100); // 100ms debounce
        }

        // Show stream panel
        function showStreamPanel() {
            if (!currentStream) return;
            
            const panel = document.getElementById('streamPanel');
            const title = document.getElementById('streamTitle');
            const info = document.getElementById('streamInfo');
            const output = document.getElementById('streamOutput');
            
            // Clear previous stream content
            if (output) {
                output.textContent = '';
            }
            
            // Update the title immediately
            if (title) {
                title.textContent = `${currentStream.windowName}: ${currentStream.paneName}`;
                console.log('Updated stream title to:', title.textContent);
            } else {
                console.error('streamTitle element not found');
            }
                
            // Set up initial info content
            const sessionName = currentSession && currentSession.friendly_name ? 
                currentSession.friendly_name : currentStream.session;
            
            info.innerHTML = `
                <div class="stream-info-content">
                    <div class="stream-info-main">
                        <span class="stream-status connected"></span>
                        <span class="stream-command" id="streamCommand">Loading command...</span>
                        <button class="copy-btn" id="copyStreamCommand" onclick="copyStreamCommand(event)" title="Copy command" style="display: none;">Copy</button>
                    </div>
                    <div class="stream-info-details">
                        <span class="stream-update-time">Updated: <span id="streamTimestamp">${new Date().toLocaleString()}</span></span>
                        <span class="stream-connection-status">Live</span>
                    </div>
                </div>
            `;
            
            updateStreamPanelDisplay();
            
            panel.classList.add('open');
            
            // Add stream-panel-open class to right panel
            const rightPanel = document.getElementById('rightPanel');
            rightPanel.classList.add('stream-panel-open');
            
            // Update command display
            updateStreamCommand();
        }

        // Start streaming
        function startStream() {
            if (!currentStream || isStreamPaused) return;
            
            // Close any existing EventSource connection
            if (streamEventSource) {
                streamEventSource.close();
                streamEventSource = null;
            }
            
            const url = `${API_BASE}/tmux/sessions/${currentStream.session}/windows/${currentStream.window}/panes/${currentStream.pane}/stream`;
            
            streamEventSource = new EventSource(url);
            
            streamEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    document.getElementById('streamOutput').innerHTML = `Error: ${data.error}`;
                    return;
                }
                
                const output = document.getElementById('streamOutput');
                const timestamp = document.getElementById('streamTimestamp');
                
                // Handle incremental updates from backend
                if (data.updateType) {
                    const currentContent = output.textContent;
                    
                    switch (data.updateType) {
                        case 'append':
                            // Append new content
                            if (data.content) {
                                output.textContent = currentContent + data.content;
                            }
                            break;
                            
                        case 'partial':
                            // Partial update with common prefix
                            if (data.content) {
                                const beforeContent = currentContent.substring(0, data.startIndex);
                                output.textContent = beforeContent + data.content;
                            }
                            break;
                            
                        case 'truncate':
                            // Content was truncated
                            output.textContent = data.fullContent || data.content;
                            break;
                            
                        case 'full':
                        default:
                            // Full content replacement
                            output.textContent = data.fullContent || data.content;
                            break;
                    }
                } else {
                    // Fallback for old format
                    const currentContent = output.textContent;
                    const newContent = data.content;
                    
                    if (currentContent !== newContent) {
                        output.textContent = newContent;
                    }
                }
                
                // Only update timestamp if it's significantly different (every 5 seconds)
                const currentTime = new Date();
                const lastUpdate = timestamp.dataset.lastUpdate ? new Date(timestamp.dataset.lastUpdate) : new Date(0);
                if (currentTime - lastUpdate > 5000) {
                    timestamp.textContent = currentTime.toLocaleString();
                    timestamp.dataset.lastUpdate = currentTime.toISOString();
                }
                
                // Auto-scroll to bottom
                output.scrollTop = output.scrollHeight;
            };
            
            streamEventSource.onerror = function(event) {
                document.getElementById('streamOutput').innerHTML = 'Stream connection error. Trying to reconnect...';
                setTimeout(() => {
                    if (streamEventSource) {
                        streamEventSource.close();
                        startStream();
                    }
                }, 5000);
            };
        }

        // Toggle stream pause/resume
        function toggleStream() {
            const btn = document.getElementById('toggleStreamBtn');
            const status = document.querySelector('.stream-status');
            
            if (isStreamPaused) {
                // Resume
                isStreamPaused = false;
                btn.textContent = 'Pause';
                status.className = 'stream-status connected';
                startStream();
            } else {
                // Pause
                isStreamPaused = true;
                btn.textContent = 'Resume';
                status.className = 'stream-status paused';
                if (streamEventSource) {
                    streamEventSource.close();
                    streamEventSource = null;
                }
            }
        }

        // Refresh stream
        function refreshStream() {
            if (streamEventSource) {
                streamEventSource.close();
            }
            startStream();
        }

        // Close stream panel
        function closeStreamPanel() {
            const panel = document.getElementById('streamPanel');
            panel.classList.remove('open');
            
            // Remove stream-panel-open class from right panel
            const rightPanel = document.getElementById('rightPanel');
            rightPanel.classList.remove('stream-panel-open');
            
            // Clear the stream output
            const output = document.getElementById('streamOutput');
            if (output) {
                output.textContent = '';
            }
            
            // Close EventSource connection
            if (streamEventSource) {
                streamEventSource.close();
                streamEventSource = null;
            }
            
            // Reset stream state
            currentStream = null;
            isStreamPaused = false;
        }

        // Close all panels
        function closeAllPanels() {
            closeRightPanel();
        }

        // Minimize panels (reduce opacity)
        function minimizePanels() {
            const rightPanel = document.getElementById('rightPanel');
            
            if (rightPanel.classList.contains('open')) {
                rightPanel.style.opacity = '0.3';
            }
            
            // Add click to restore functionality
            document.addEventListener('click', restorePanels, { once: true });
        }

        // Restore panels opacity
        function restorePanels() {
            const rightPanel = document.getElementById('rightPanel');
            
            rightPanel.style.opacity = '1';
        }

        // Check if any panels are open and hide quick actions if none
        function checkAndHideQuickActions() {
            const rightPanel = document.getElementById('rightPanel');
            const quickActions = document.getElementById('quickActions');
            const panelStatus = document.getElementById('panelStatus');
            
            if (!rightPanel.classList.contains('open')) {
                quickActions.classList.remove('open');
                panelStatus.classList.remove('show');
            }
        }

        // Close top panel (stream panel first, then right panel)
        function closeTopPanel() {
            // Close stream panel first, then right panel
            if (document.getElementById('streamPanel').classList.contains('open')) {
                closeStreamPanel();
            } else if (document.getElementById('rightPanel').classList.contains('open')) {
                closeRightPanel();
            }
        }

        // Open details panel in right panel
        function openDetailsPanel(sessionName) {
            console.log('Opening details panel for session:', sessionName);
            getSessionInfo(sessionName);
        }

        // Edit friendly name
        function editFriendlyName(sessionName, currentName) {
            openEditFriendlyNameModal(sessionName, currentName);
        }

        // Set friendly name
        async function setFriendlyName(sessionName, friendlyName) {
            try {
                const response = await fetch(`${API_BASE}/tmux/session-names/${sessionName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ friendly_name: friendlyName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Friendly name '${friendlyName}' set for session '${sessionName}'`);
                    loadSessions(); // Refresh the display
                } else {
                    showError('Failed to set friendly name: ' + data.error);
                }
            } catch (error) {
                showError('Failed to set friendly name: ' + error.message);
            }
        }

        // Remove friendly name
        async function removeFriendlyName(sessionName) {
            try {
                const response = await fetch(`${API_BASE}/tmux/session-names/${sessionName}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Friendly name removed for session '${sessionName}'`);
                    loadSessions(); // Refresh the display
                } else {
                    showError('Failed to remove friendly name: ' + data.error);
                }
            } catch (error) {
                showError('Failed to remove friendly name: ' + error.message);
            }
        }

        // Show success message
        function showSuccess(message) {
            showNotification(message, 'success');
        }

        // Window Management Functions
        async function createNewWindow(sessionName) {
            try {
                // Use tmux command to create a new window
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: 'new-window'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('New window created successfully');
                    // Update window dropdown and panes
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to create new window: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to create new window: ' + error.message);
            }
        }

        async function renameCurrentWindow(sessionName) {
            const select = document.getElementById('windowSelect');
            if (!select || select.value === '') {
                showError('Please select a window first');
                return;
            }
            
            const windowIndex = parseInt(select.value);
            const currentWindow = currentSession.windows_info.find(w => w.index === windowIndex);
            
            if (!currentWindow) {
                showError('Window not found');
                return;
            }
            
            // Open the rename window modal
            openRenameWindowModal(sessionName, windowIndex, currentWindow.name);
        }

        async function killCurrentWindow(sessionName) {
            const select = document.getElementById('windowSelect');
            if (!select || select.value === '') {
                showError('Please select a window first');
                return;
            }
            
            const windowIndex = parseInt(select.value);
            const currentWindow = currentSession.windows_info.find(w => w.index === windowIndex);
            
            if (!currentWindow) {
                showError('Window not found');
                return;
            }
            
            // Open the delete window modal
            openDeleteWindowModal(sessionName, windowIndex, currentWindow.name);
        }

        async function activateCurrentWindow(sessionName) {
            const select = document.getElementById('windowSelect');
            if (!select || select.value === '') {
                showError('Please select a window first');
                return;
            }
            
            const windowIndex = parseInt(select.value);
            const currentWindow = currentSession.windows_info.find(w => w.index === windowIndex);
            
            if (!currentWindow) {
                showError('Window not found');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `select-window -t ${sessionName}:${windowIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Window "${currentWindow.name}" activated successfully`);
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to activate window: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to activate window: ' + error.message);
            }
        }



        async function splitPaneHorizontally(sessionName, event) {
            // Stop event propagation to prevent triggering the pane click
            if (event) {
                event.stopPropagation();
            }
            const select = document.getElementById('windowSelect');
            if (!select || select.value === '') {
                showError('Please select a window first');
                return;
            }
            
            const windowIndex = parseInt(select.value);
            
            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `split-window -h -t ${sessionName}:${windowIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Pane split horizontally');
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to split pane: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to split pane: ' + error.message);
            }
        }

        async function splitPaneVertically(sessionName, event) {
            // Stop event propagation to prevent triggering the pane click
            if (event) {
                event.stopPropagation();
            }
            const select = document.getElementById('windowSelect');
            if (!select || select.value === '') {
                showError('Please select a window first');
                return;
            }
            
            const windowIndex = parseInt(select.value);
            
            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `split-window -v -t ${sessionName}:${windowIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Pane split vertically');
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to split pane: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to split pane: ' + error.message);
            }
        }

        async function killCurrentPane(sessionName) {
            const select = document.getElementById('windowSelect');
            if (!select || select.value === '') {
                showError('Please select a window first');
                return;
            }
            
            const windowIndex = parseInt(select.value);
            const currentWindow = currentSession.windows_info.find(w => w.index === windowIndex);
            
            if (!currentWindow) {
                showError('Window not found');
                return;
            }
            
            if (!currentWindow.panes || currentWindow.panes.length === 0) {
                showError('No panes available to kill');
                return;
            }
            
            // Open the delete current pane modal
            openDeleteCurrentPaneModal(sessionName, windowIndex, currentWindow.name);
        }

        async function killSpecificPane(sessionName, windowIndex, paneIndex, event) {
            // Stop event propagation to prevent triggering the pane click
            if (event) {
                event.stopPropagation();
            }
            
            // Get current pane name for better confirmation message
            const currentWindow = currentSession.windows_info.find(w => w.index === windowIndex);
            const currentPane = currentWindow?.panes?.find(p => p.index === paneIndex);
            const currentPaneName = currentPane?.name || `Pane ${paneIndex}`;
            
            // Open the delete pane modal
            openDeletePaneModal(sessionName, windowIndex, paneIndex, currentPaneName);
        }

        async function activatePane(sessionName, windowIndex, paneIndex, event) {
            // Stop event propagation to prevent triggering the pane click
            if (event) {
                event.stopPropagation();
            }
            
            try {
                const response = await fetch(`${API_BASE}/tmux/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session: sessionName,
                        command: `select-pane -t ${sessionName}:${windowIndex}.${paneIndex}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Pane ${paneIndex} activated successfully`);
                    getSessionInfo(sessionName);
                } else {
                    showError('Failed to activate pane: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Failed to activate pane: ' + error.message);
            }
        }

        async function renameSpecificPane(sessionName, windowIndex, paneIndex, event) {
            // Stop event propagation to prevent triggering the pane click
            if (event) {
                event.stopPropagation();
            }
            
            // Get current pane name
            const currentWindow = currentSession.windows_info.find(w => w.index === windowIndex);
            const currentPane = currentWindow?.panes?.find(p => p.index === paneIndex);
            const currentPaneName = currentPane?.name || `Pane ${paneIndex}`;
            
            // Open the rename pane modal
            openRenamePaneModal(sessionName, windowIndex, paneIndex, currentPaneName);
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadSessions();
            checkServiceStatus();
        }, 30000);


    </script>
</body>
</html>
